# Phase 2: Neo4j Graph Schema Design

This document outlines the proposed Neo4j graph schema for storing the Code Property Graph (CPG) data generated by Joern. The schema is derived directly from the structure and content observed in the Joern Neo4j CSV export files.

## 1. Design Goals

*   **Accurate Representation:** Faithfully represent the nodes, relationships, and properties captured by Joern's CPG.
*   **Efficiency:** Facilitate efficient querying for common code analysis tasks.
*   **Clarity:** Provide a clear and understandable mapping between Joern's CPG concepts and the Neo4j graph structure.

## 2. Schema Elements

The schema mirrors Joern's export structure:

### 2.1. Node Labels

Node labels correspond directly to the node types exported by Joern (identified from `nodes_*_header.csv` files).

**Common Node Labels:**

*   `:MetaData`: Contains metadata about the CPG generation (language, overlays).
*   `:File`: Represents source code files.
*   `:Namespace`: Represents namespaces or packages.
*   `:NamespaceBlock`: Represents blocks within namespaces.
*   `:TypeDecl`: Type declarations (classes, structs, enums).
*   `:Type`: Represents types.
*   `:Method`: Functions or methods.
*   `:MethodParameterIn`: Input parameters for methods.
*   `:MethodParameterOut`: Output parameters (less common, depends on language).
*   `:MethodReturn`: Return type definition for methods.
*   `:Member`: Class or struct members (fields).
*   `:Local`: Local variables within methods.
*   `:Call`: Function or method call sites.
*   `:Identifier`: Variable or function name occurrences.
*   `:Literal`: Constant values (strings, numbers).
*   `:Return`: Return statements.
*   `:Block`: Code blocks (e.g., within methods or control structures).
*   `:ControlStructure`: Control flow constructs (if, for, while).
*   `:MethodRef`: References to methods (e.g., for function pointers or dynamic calls).
*   `:TypeRef`: References to types.
*   `:Binding`: Represents the binding between a call site and potential target methods.
*   `:ClosureBinding`: Represents bindings related to closures.
*   `:Modifier`: Access modifiers (public, private, static).

*(This list is based on the observed export files and may vary slightly depending on the source language and Joern version.)*

### 2.2. Relationship Types

Relationship types correspond directly to the edge types exported by Joern (identified from `edges_*_header.csv` files).

**Common Relationship Types:**

*   `:AST`: Links nodes in the Abstract Syntax Tree structure (parent-child).
*   `:CFG`: Links nodes in the Control Flow Graph, representing execution order.
*   `:CDG`: Links nodes in the Control Dependence Graph.
*   `:REACHING_DEF`: Connects variable uses (`Identifier`) to their defining assignments (`Call`, `Local`).
*   `:CALL`: Links call sites (`Call`) to the corresponding method nodes (`Method`).
*   `:ARGUMENT`: Links call sites (`Call`) to their argument expressions/nodes.
*   `:RECEIVER`: Links call sites (`Call`) to the object/instance receiving the call.
*   `:CONTAINS`: Links container nodes (e.g., `File`, `Method`, `TypeDecl`, `Block`) to the nodes they contain.
*   `:SOURCE_FILE`: Links nodes (like `Method`, `TypeDecl`) to the `:File` node they originate from.
*   `:PARAMETER_LINK`: Links method parameters (`MethodParameterIn`) to corresponding `MethodParameterOut` nodes.
*   `:EVAL_TYPE`: Links expressions/identifiers to their resolved `:Type` nodes.
*   `:INHERITS_FROM`: Links `:TypeDecl` nodes to the types they inherit from.
*   `:BINDS`: Links `:Binding` nodes to the `:Method` nodes they represent.
*   `:CAPTURE`: Links `:ClosureBinding` nodes to the `:Local` or `:MethodParameterIn` they capture.
*   `:REF`: Links reference nodes (e.g., `:Identifier`, `:MethodRef`) to the nodes they refer to (e.g., `:Local`, `:Method`).
*   `:DOMINATE`: Represents dominance relationships in the CFG.
*   `:POST_DOMINATE`: Represents post-dominance relationships in the CFG.
*   `:CONDITION`: Links control structures (`ControlStructure`) to their condition expressions.

### 2.3. Node Properties

Properties are derived from the columns listed in the `nodes_*_header.csv` files.

**Key Properties (Examples):**

*   `code`: The source code snippet corresponding to the node.
*   `name`: The simple name of the element (e.g., variable name, method name).
*   `fullName`: The fully qualified name (e.g., `package.class.method`).
*   `signature`: Method or function signature.
*   `typeFullName`: The fully qualified name of the node's type.
*   `lineNumber`: Starting line number in the source file.
*   `columnNumber`: Starting column number.
*   `lineNumberEnd`: Ending line number.
*   `columnNumberEnd`: Ending column number.
*   `filename`: Name of the source file (property on `:File` nodes, also often duplicated on other nodes for convenience).
*   `order`: The order of the node among siblings in the AST.
*   `argumentIndex`: The index of an argument in a call or parameter list.
*   `dispatchType`: Type of call dispatch (STATIC, DYNAMIC).
*   `isExternal`: Boolean flag indicating if a method/type is external to the analyzed code.
*   `hash`: A hash value associated with the node (often related to code content).
*   `joernId`: The original ID from the Joern CSV `:ID` column (useful for debugging/traceability, distinct from Neo4j's internal ID).

### 2.4. Relationship Properties

Based on the examined `edges_AST_header.csv`, basic structural relationships like `:AST` typically only contain `:START_ID`, `:END_ID`, and `:TYPE`. More complex relationships derived from specific analyses (like `:REACHING_DEF`) might contain additional properties, but these were not explicitly examined in this phase. Assume relationships are primarily structural unless specific analysis requires property storage on edges.

## 3. Indexing Strategy

To ensure efficient querying, create indexes on commonly accessed properties:

*   **Node Property Indexes:**
    *   `CREATE INDEX node_method_fullname IF NOT EXISTS FOR (n:Method) ON (n.fullName);`
    *   `CREATE INDEX node_typedecl_fullname IF NOT EXISTS FOR (n:TypeDecl) ON (n.fullName);`
    *   `CREATE INDEX node_file_name IF NOT EXISTS FOR (n:File) ON (n.name);`
    *   `CREATE INDEX node_identifier_name IF NOT EXISTS FOR (n:Identifier) ON (n.name);`
    *   `CREATE INDEX node_call_methodfullname IF NOT EXISTS FOR (n:Call) ON (n.methodFullName);`
    *   `CREATE INDEX node_name IF NOT EXISTS FOR (n:!) ON (n.name);` *(Generic index on `name` for various node types)*
    *   `CREATE INDEX node_code IF NOT EXISTS FOR (n:!) ON (n.code);` *(Optional: If frequent code searches are needed)*
    *   `CREATE INDEX node_linenumber IF NOT EXISTS FOR (n:!) ON (n.lineNumber);` *(Optional: If frequent location-based searches are needed)*

*   **Relationship Property Indexes:** Generally not needed unless relationships store significant queryable data beyond their type and connected nodes.

## 4. Justification

*   **Direct Mapping:** This schema provides a 1:1 mapping from the Joern export, ensuring all generated data is captured and easily understood by users familiar with Joern/CPG concepts.
*   **Standard Properties:** Leverages standard CPG properties (`code`, `lineNumber`, `fullName`, etc.) for consistency.
*   **Performance:** Includes essential indexes on frequently queried properties like names and full names to optimize common analysis queries (e.g., finding methods, types, or calls).
*   **Extensibility:** The schema can be extended later if custom analyses add new node/relationship types or properties.

This schema provides a solid foundation for importing the Joern CPG data into Neo4j and performing subsequent code analysis tasks.